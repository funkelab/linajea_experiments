[general]
logging = 20
db_host = "mongodb://linajeaAdmin:FeOOHnH2O@funke-mongodb4/admin?replicaSet=rsLinajea"
seed = 42
sparse = false
setup_dir = "/groups/funke/home/hirschp/linajea_experiments/unet_setups/celegans_setups"

[model]
train_input_shape = [ 7, 148, 148, 148,]
predict_input_shape = [ 7, 260, 260, 260,]
num_fmaps = 12
fmap_inc_factors = 4
downsample_factors = [[ 2, 2, 2,],
                      [ 2, 2, 2,],
                      [ 2, 2, 2,],]
kernel_size_down = [[ [3, 3, 3, 3], [3, 3, 3, 3],],
                    [ [3, 3, 3, 3], [3, 3, 3],],
                    [ [3, 3, 3], [3, 3, 3],],
                    [ [3, 3, 3], [3, 3, 3],],]
kernel_size_up = [[ [3, 3, 3], [3, 3, 3],],
                  [ [3, 3, 3], [3, 3, 3],],
                  [ [3, 3, 3], [3, 3, 3],],]
# constant_upsample = true
# upsampling = "pixel_shuffle"
# upsampling = "trilinear"
upsampling = "sep_transposed_conv"
average_vectors = false
nms_window_shape = [ 11, 11, 11,]
path_to_script = "/groups/funke/home/hirschp/linajea_experiments/unet_setups/celegans_setups/mknet_celegans.py"

[train]
val_log_step = 10
parent_radius = [ 0.1, 8.0, 8.0, 8.0,]
rasterize_radius = [ 0.1, 3.0, 3.0, 3.0,]
move_radius = 40
cache_size = 10
parent_vectors_loss_transition_offset = 50000
parent_vectors_loss_transition_factor = 0.0005
path_to_script = "/groups/funke/home/hirschp/linajea_experiments/unet_setups/celegans_setups/train_val_celegans.py"
max_iterations = 100000
checkpoint_stride = 10000
snapshot_stride = 1000
profiling_stride = 100

[optimizerTF1]
optimizer = "AdamOptimizer"

[extract]
block_size = [ 5, 512, 512, 512,]

[solve]
from_scratch = true
non_minimal = true
write_struct_svm = true
check_node_close_to_roi = false
add_node_density_constraints = true
[[solve.parameters]]
cost_appear = 10000000000.0
cost_disappear = 100000.0
cost_split = 0
threshold_split_score = -1
threshold_node_score = 0.35
threshold_edge_score = 0.5
weight_node_score = 100
weight_prediction_distance_cost = 1
block_size = [ 5, 512, 512, 512,]
context = [ 2, 100, 100, 100,]
use_cell_state = false

[evaluate]
from_scratch = false

[predict]
path_to_script = "/groups/funke/home/hirschp/linajea_experiments/unet_setups/celegans_setups/predict_celegans.py"
path_to_script_db_from_zarr = "/groups/funke/home/hirschp/linajea_experiments/unet_setups/celegans_setups/write_cells_celegans.py"
output_zarr_prefix = "/nrs/funke/hirschp/linajea_experiments"
write_to_zarr = false
write_to_db = true
write_db_from_zarr = false
processes_per_worker = 5

[train_data]
voxel_size = [ 1, 1, 1, 1,]
[[train_data.data_sources]]
gt_db_name = "linajea_celegans_mskcc_emb3"

[train_data.data_sources.datafile]
filename = "/nrs/funke/hirschp/mskcc_lightsheet/mskcc_lightsheet_emb1"
group = "volumes/raw_nested"

[test_data]
checkpoint = 1000
cell_score_threshold = 0.3
voxel_size = [ 1, 1, 1, 1,]
[[test_data.data_sources]]
gt_db_name = "linajea_celegans_mskcc_emb3"

[test_data.data_sources.datafile]
filename = "/nrs/funke/hirschp/mskcc_lightsheet/mskcc_lightsheet_emb3"
group = "volumes/raw_nested"

[validate_data]
checkpoints = [ 1000,]
cell_score_threshold = 0.3
voxel_size = [ 1, 1, 1, 1,]
[[validate_data.data_sources]]
gt_db_name = "linajea_celegans_mskcc_emb3"

[validate_data.data_sources.datafile]
filename = "/nrs/funke/hirschp/mskcc_lightsheet/mskcc_lightsheet_emb2"
group = "volumes/raw_nested"

[train.use_radius]
30 = 18
60 = 15
110 = 13
150 = 9
1000 = 6

[train.job]
num_workers = 5
queue = "gpu_rtx"

[train.augment]
divisions = true
reject_empty_prob = 0.99
perc_min = "perc0_01"
perc_max = "perc99_99"
norm_bounds = [ 2000, 7500,]

[optimizerTF1.args]
learning_rate = 5e-5

[optimizerTF1.kwargs]
beta1 = 0.95
beta2 = 0.999
epsilon = 1e-8

[extract.edge_move_threshold]
50 = 45
1000 = 35

[extract.job]
num_workers = 32
queue = "local"

[solve.job]
num_workers = 8
queue = "local"

[evaluate.parameters]
matching_threshold = 15
sparse = false

[evaluate.job]
num_workers = 1
queue = "local"

[predict.job]
num_workers = 4
queue = "gpu_tesla"

[train_data.roi]
offset = [ 0, 0, 0, 0,]
shape = [ 350, 512, 512, 512,]

[test_data.roi]
offset = [ 0, 0, 0, 0,]
shape = [ 350, 512, 512, 512,]

[validate_data.roi]
offset = [ 0, 0, 0, 0,]
shape = [ 350, 512, 512, 512,]

[train.augment.elastic]
control_point_spacing = [ 25, 25, 25,]
jitter_sigma = [ 1, 1, 1,]
rotation_min = 0
rotation_max = 90
subsample = 8

[train.augment.shift]
prob_slip = 0.3
prob_shift = 0.3
sigma = [ 0, 4, 4, 4,]

[train.augment.intensity]
scale = [ 0.9, 1.1,]
shift = [ -0.001, 0.001,]

[train.augment.simple]
mirror = [ 1, 2, 3,]
transpose = [ 1, 2, 3,]
